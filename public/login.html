<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In | Equity Coffee</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #e9741e;
      --primary-dark: #b54714;
      --dark: #0f172a;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --radius: 12px;
      --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Inter',sans-serif;background:#f8fafc;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative;
    }
    .bg-watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:60%;opacity:.03;z-index:-1;pointer-events:none;}
    .auth-card{
      display:grid;grid-template-columns:1.1fr .9fr;width:100%;max-width:1000px;height:650px;background:#fff;border-radius:24px;box-shadow:var(--shadow);overflow:hidden;margin:20px;
    }
    .branding-side{background:var(--dark);padding:60px;color:#fff;display:flex;flex-direction:column;justify-content:space-between;position:relative;}
    .branding-side::after{
      content:'';position:absolute;bottom:-10%;right:-10%;width:300px;height:300px;background:url('images/logo.png') no-repeat center;background-size:contain;opacity:.1;filter:grayscale(1);
    }
    .logo-area{display:flex;align-items:center;gap:12px;text-decoration:none;color:#fff;}
    .logo-area img{height:40px;}
    .logo-area span{font-family:'Poppins';font-weight:700;font-size:1.5rem;}
    .branding-content h2{font-family:'Poppins';font-size:2.5rem;line-height:1.2;margin-bottom:20px;}
    .feature-list{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
    .feature-item{font-size:.85rem;opacity:.7;display:flex;align-items:center;gap:10px;}
    .feature-item i{color:var(--primary);}
    .login-side{padding:60px;display:flex;flex-direction:column;justify-content:center;}
    .header-text h1{font-family:'Poppins';font-size:2rem;color:var(--dark);margin-bottom:8px;}
    .header-text p{color:var(--text-muted);margin-bottom:14px;}

    .status{display:none;margin:12px 0 16px;padding:12px 14px;border-radius:12px;font-size:.92rem;border:1px solid transparent;}
    .status.show{display:block;}
    .status.success{background:#ecfdf5;border-color:#a7f3d0;color:#065f46;}
    .status.error{background:#fef2f2;border-color:#fecaca;color:#7f1d1d;}

    .input-group{margin-bottom:18px;}
    .input-group label{display:block;font-size:.85rem;font-weight:600;margin-bottom:8px;color:var(--text-main);}
    .input-wrapper{position:relative;}
    .input-wrapper i{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--text-muted);}
    .input-wrapper input{width:100%;padding:14px 15px 14px 45px;border:1.5px solid #e2e8f0;border-radius:var(--radius);font-size:1rem;transition:.2s;}
    .input-wrapper input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(233,116,30,.1);}

    .btn-submit{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;border-radius:var(--radius);font-size:1rem;font-weight:600;cursor:pointer;box-shadow:0 10px 15px -3px rgba(233,116,30,.3);transition:.2s;margin-top:6px;}
    .btn-submit:hover{transform:translateY(-1px);}
    .btn-submit:disabled{opacity:.7;cursor:not-allowed;transform:none;}

    .footer-link{text-align:center;margin-top:18px;font-size:.9rem;color:var(--text-muted);}
    .footer-link a{color:var(--primary);font-weight:600;text-decoration:none;}

    @media (max-width:900px){
      .auth-card{grid-template-columns:1fr;max-width:450px;height:auto;}
      .branding-side{display:none;}
    }
  </style>
</head>
<body>
  <img src="images/logo.png" class="bg-watermark" alt="Equity Coffee Background">

  <div class="auth-card">
    <div class="branding-side">
      <a href="index.html" class="logo-area">
        <img src="images/logo.png" alt="Logo">
        <span>Equity Coffee</span>
      </a>

      <div class="branding-content">
        <h2>From Farm to Cup, with Trust.</h2>
        <p style="opacity:0.8;font-weight:300;">Log in to access the world's most transparent coffee trade network.</p>
      </div>

      <div class="feature-list">
        <div class="feature-item"><i class="fas fa-check-circle"></i> Direct Sourcing</div>
        <div class="feature-item"><i class="fas fa-check-circle"></i> Secure Payments</div>
        <div class="feature-item"><i class="fas fa-check-circle"></i> Data Insights</div>
        <div class="feature-item"><i class="fas fa-check-circle"></i> Global Logistics</div>
      </div>
    </div>

    <div class="login-side">
      <div class="header-text">
        <h1>Welcome Back</h1>
        <p>Sign in to your dashboard</p>
      </div>

      <div id="status" class="status"></div>

      <form id="login-form">
        <div class="input-group">
          <label for="email">Email Address</label>
          <div class="input-wrapper">
            <i class="fas fa-envelope"></i>
            <input id="email" type="email" placeholder="name@company.com" autocomplete="email" required>
          </div>
        </div>

        <div class="input-group">
          <div style="display:flex;justify-content:space-between;">
            <label for="password">Password</label>
            <a href="forgot-password.html" style="font-size:0.75rem;color:var(--primary);text-decoration:none;">Forgot?</a>
          </div>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required>
          </div>
        </div>

        <button id="btnLogin" type="submit" class="btn-submit">
          Sign In <i class="fas fa-arrow-right" style="margin-left:8px;"></i>
        </button>
      </form>

      <p class="footer-link">Don't have an account? <a href="get-started.html">Register</a></p>
    </div>
  </div>

  <script src="js/common-auth.js"></script>
  <script>
    const BACKEND_BASE = ""; // set to your backend Render URL if backend is separate, e.g. "https://xxx.onrender.com"
    const ENDPOINTS = ["/api/auth/login", "/auth/login", "/api/login"];

    const statusEl = document.getElementById("status");
    const btn = document.getElementById("btnLogin");

    function setStatus(type, msg) {
      statusEl.className = "status show " + type;
      statusEl.textContent = msg;
    }
    function clearStatus() {
      statusEl.className = "status";
      statusEl.textContent = "";
    }

    function setAuth(token, user) {
      if (window.ECAuth && typeof window.ECAuth.setAuth === "function") {
        window.ECAuth.setAuth(token, user);
      } else {
        localStorage.setItem("ec_token", token);
        localStorage.setItem("ec_user", JSON.stringify(user));
      }
    }

    function redirectByRole(role) {
      const map = {
        farmer: "farmer/dashboard-farmer.html",
        trader: "trader/dashboard-trader.html",
        roaster: "roaster/dashboard-roaster.html",
        logistics: "logistics/dashboard-logistics.html",
        admin: "admin/dashboard-admin.html",
        educator: "educator/dashboard-educator.html"
      };
      location.href = map[role] || "index.html";
    }

    async function postJson(url, payload) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      return { res, data };
    }

    async function login(payload) {
      const bases = Array.from(new Set(["", (BACKEND_BASE || "").replace(/\/$/, "")]));
      let lastMessage = "Login failed.";

      for (const base of bases) {
        for (const path of ENDPOINTS) {
          const url = `${base}${path}`;
          try {
            const { res, data } = await postJson(url, payload);
            if (res.ok && data.token && data.user) return { ok: true, data, urlUsed: url };
            lastMessage = data.message || `Login failed on ${url}`;
          } catch (e) {
            lastMessage = `Network/CORS error on ${url}`;
          }
        }
      }
      return { ok: false, message: lastMessage };
    }

    // auto-skip if already logged in
    (function () {
      try {
        const token = localStorage.getItem("ec_token");
        const userStr = localStorage.getItem("ec_user");
        if (!token || !userStr) return;
        const user = JSON.parse(userStr);
        if (user && user.role) redirectByRole(user.role);
      } catch (_) {}
    })();

    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      clearStatus();

      const email = document.getElementById("email").value.trim().toLowerCase();
      const password = document.getElementById("password").value;

      if (!email || !password) return setStatus("error", "Please enter email and password.");

      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

      const result = await login({ email, password });

      if (!result.ok) {
        setStatus("error", result.message + "  (If backend is separate, set BACKEND_BASE in login.html)");
        btn.disabled = false;
        btn.innerHTML = 'Sign In <i class="fas fa-arrow-right" style="margin-left:8px;"></i>';
        return;
      }

      setAuth(result.data.token, result.data.user);
      setStatus("success", "Login successful. Redirecting...");
      setTimeout(() => redirectByRole(result.data.user.role), 600);
    });
  </script>
</body>
</html>
