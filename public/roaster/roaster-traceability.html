<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Traceability – Equity Coffee Roaster</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
  <div class="dashboard-shell">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="/images/logo.png" alt="Equity Coffee Logo" class="logo-image">
          <div class="logo-text">
            <span class="logo-primary">Equity Coffee</span>
            <span class="logo-secondary">Traceability</span>
          </div>
        </div>
        <button class="sidebar-close" id="sidebar-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <ul class="sidebar-nav">
        <li>
          <a class="sidebar-link" href="dashboard-roaster.html">
            <i class="fas fa-chart-line"></i>
            <span>Dashboard</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="roaster-sourcing.html">
            <i class="fas fa-search"></i>
            <span>Sourcing</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="roaster-inventory.html">
            <i class="fas fa-boxes"></i>
            <span>Inventory</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link active" href="roaster-traceability.html">
            <i class="fas fa-qrcode"></i>
            <span>Traceability</span>
            <span class="sidebar-badge">12</span>
          </a>
        </li>
        <li>
          <a class="sidebar-link" href="roaster-consumers.html">
            <i class="fas fa-users"></i>
            <span>Consumers</span>
          </a>
        </li>
      </ul>
      
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar">DC</div>
          <div class="user-info">
            <div class="user-name">Deep Concept Roastery</div>
            <div class="user-email">trace@deepconcept.com</div>
          </div>
        </div>
        <button class="btn-logout">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </aside>

    <div class="dashboard-main">
      <header class="topbar">
        <div class="topbar-left">
          <button class="sidebar-toggle" id="sidebar-toggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="page-header">
            <h1>Traceability Management</h1>
            <p class="page-subtitle">Keep traceable stories attached to every lot and consumer touchpoint</p>
          </div>
        </div>
        <div class="topbar-right">
          <div class="topbar-actions">
            <button class="btn-icon" title="QR Generator">
              <i class="fas fa-qrcode"></i>
            </button>
            <button class="btn-icon" title="Print Labels">
              <i class="fas fa-print"></i>
            </button>
            <button class="btn-icon" title="Settings">
              <i class="fas fa-cog"></i>
            </button>
          </div>
          <div class="topbar-divider"></div>
          <div class="quick-stats">
            <div class="quick-stat">
              <span class="stat-label">Active Scans</span>
              <span class="stat-value">3,240</span>
            </div>
          </div>
        </div>
      </header>

      <main class="dashboard-content">
        <!-- Traceability Overview -->
        <section class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #3B82F6, #60A5FA);">
                <i class="fas fa-map-marked-alt"></i>
              </div>
              <div class="kpi-label">Traced Lots</div>
            </div>
            <div class="kpi-value">42</div>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span>+8 this month</span>
            </div>
            <div class="kpi-meta">Complete farm-to-cup journeys</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
                <i class="fas fa-qrcode"></i>
              </div>
              <div class="kpi-label">Active QR Codes</div>
            </div>
            <div class="kpi-value">156</div>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span>+24% growth</span>
            </div>
            <div class="kpi-meta">On retail bags & displays</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
                <i class="fas fa-eye"></i>
              </div>
              <div class="kpi-label">Total Views</div>
            </div>
            <div class="kpi-value">12.8k</div>
            <div class="kpi-trend positive">
              <i class="fas fa-arrow-up"></i>
              <span>+2.1k this week</span>
            </div>
            <div class="kpi-meta">Consumer trace page views</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-header">
              <div class="kpi-icon" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);">
                <i class="fas fa-star"></i>
              </div>
              <div class="kpi-label">Avg. Engagement</div>
            </div>
            <div class="kpi-value">2.4<span class="kpi-unit">m</span></div>
            <div class="kpi-trend">
              <span>Time on trace pages</span>
            </div>
            <div class="kpi-meta">Per consumer visit</div>
          </div>
        </section>

        <!-- Main Content Grid -->
        <div class="content-grid">
          <!-- Left Column -->
          <div class="content-column">
            <!-- Trace Search -->
            <div class="panel">
              <div class="panel-header">
                <h2><i class="fas fa-search"></i> Traceability Search</h2>
                <p class="panel-subtitle">Look up any lot and show its full journey to your team or customers</p>
              </div>
              <div class="panel-body">
                <div class="trace-search">
                  <div class="search-header">
                    <div class="search-tabs">
                      <button class="search-tab active" data-tab="lot">Search by Lot</button>
                      <button class="search-tab" data-tab="qr">Search by QR Code</button>
                      <button class="search-tab" data-tab="farm">Search by Farm</button>
                    </div>
                  </div>
                  
                  <div class="search-content">
                    <div class="search-input-group">
                      <i class="fas fa-search search-icon"></i>
                      <input 
                        type="text" 
                        id="trace-code"
                        placeholder="Enter lot code, QR code, or farm name..."
                        class="search-input"
                      />
                      <button class="btn btn-primary" id="trace-search-btn">
                        <i class="fas fa-external-link-alt"></i>
                        Open Trace
                      </button>
                    </div>
                    
                    <div class="search-hints">
                      <div class="hint-section">
                        <div class="hint-title">Recent Searches</div>
                        <div class="hint-tags">
                          <span class="hint-tag" data-code="EC-84KIR-2024">EC-84KIR-2024</span>
                          <span class="hint-tag" data-code="EC-ET-GD-24">EC-ET-GD-24</span>
                          <span class="hint-tag" data-code="LOT-2024-BR-001">LOT-2024-BR-001</span>
                        </div>
                      </div>
                      
                      <div class="hint-section">
                        <div class="hint-title">Popular Lots</div>
                        <div class="hint-tags">
                          <span class="hint-tag" data-code="KIR-AB-12">Kirinyaga AB 12</span>
                          <span class="hint-tag" data-code="GED-NAT-24">Gedeo Natural</span>
                          <span class="hint-tag" data-code="CER-EST-21">Cerrado Estate</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recent Traces -->
            <div class="panel">
              <div class="panel-header">
                <h2><i class="fas fa-history"></i> Recent Lookups</h2>
                <div class="panel-actions">
                  <select class="select-period">
                    <option>Last 24 hours</option>
                    <option>Last 7 days</option>
                    <option>Last 30 days</option>
                  </select>
                </div>
              </div>
              <div class="panel-body">
                <div class="traces-list">
                  <div class="trace-card">
                    <div class="trace-header">
                      <div class="trace-code">EC-84KIR-2024</div>
                      <div class="trace-time">2 hours ago</div>
                    </div>
                    <div class="trace-content">
                      <div class="trace-origin">
                        <span class="country-flag kenya"></span>
                        <div>
                          <div class="trace-name">Kenya Kirinyaga Bright</div>
                          <div class="trace-meta">Kirinyaga • AB Grade • Washed</div>
                        </div>
                      </div>
                      <div class="trace-stats">
                        <div class="stat-item">
                          <div class="stat-value">87.5</div>
                          <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">42</div>
                          <div class="stat-label">Bags</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">4.7★</div>
                          <div class="stat-label">Rating</div>
                        </div>
                      </div>
                    </div>
                    <div class="trace-actions">
                      <button class="btn-icon-small" title="View Full Trace">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-icon-small" title="Share Link">
                        <i class="fas fa-share"></i>
                      </button>
                      <button class="btn-icon-small" title="Download Report">
                        <i class="fas fa-download"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="trace-card">
                    <div class="trace-header">
                      <div class="trace-code">EC-ET-GD-24</div>
                      <div class="trace-time">Yesterday</div>
                    </div>
                    <div class="trace-content">
                      <div class="trace-origin">
                        <span class="country-flag ethiopia"></span>
                        <div>
                          <div class="trace-name">Gedeo Natural Filter</div>
                          <div class="trace-meta">Gedeo • Grade 1 • Natural</div>
                        </div>
                      </div>
                      <div class="trace-stats">
                        <div class="stat-item">
                          <div class="stat-value">88.0</div>
                          <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">8</div>
                          <div class="stat-label">Bags</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">4.5★</div>
                          <div class="stat-label">Rating</div>
                        </div>
                      </div>
                    </div>
                    <div class="trace-actions">
                      <button class="btn-icon-small" title="View Full Trace">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-icon-small" title="Share Link">
                        <i class="fas fa-share"></i>
                      </button>
                      <button class="btn-icon-small" title="Download Report">
                        <i class="fas fa-download"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="trace-card">
                    <div class="trace-header">
                      <div class="trace-code">LOT-2024-BR-001</div>
                      <div class="trace-time">Mar 18, 2024</div>
                    </div>
                    <div class="trace-content">
                      <div class="trace-origin">
                        <span class="country-flag brazil"></span>
                        <div>
                          <div class="trace-name">Cerrado Estate</div>
                          <div class="trace-meta">Cerrado Mineiro • Natural</div>
                        </div>
                      </div>
                      <div class="trace-stats">
                        <div class="stat-item">
                          <div class="stat-value">84.0</div>
                          <div class="stat-label">Score</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">85</div>
                          <div class="stat-label">Bags</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-value">4.4★</div>
                          <div class="stat-label">Rating</div>
                        </div>
                      </div>
                    </div>
                    <div class="trace-actions">
                      <button class="btn-icon-small" title="View Full Trace">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn-icon-small" title="Share Link">
                        <i class="fas fa-share"></i>
                      </button>
                      <button class="btn-icon-small" title="Download Report">
                        <i class="fas fa-download"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Column -->
          <div class="content-column">
            <!-- Trace Journey Preview -->
            <div class="panel">
              <div class="panel-header">
                <h2><i class="fas fa-road"></i> Sample Trace Journey</h2>
                <p class="panel-subtitle">Kirinyaga AB 12 - Farm to Cup</p>
              </div>
              <div class="panel-body">
                <div class="journey-timeline">
                  <div class="journey-step active">
                    <div class="step-icon">
                      <i class="fas fa-seedling"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Harvest & Processing</div>
                      <div class="step-description">Hand-picked at Kirinyaga farms, washed process</div>
                      <div class="step-meta">Dec 2023 • 87.5 cupping score</div>
                    </div>
                  </div>
                  
                  <div class="journey-step active">
                    <div class="step-icon">
                      <i class="fas fa-industry"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Milling & Grading</div>
                      <div class="step-description">Dry milling at Nairobi facility, AB grade sorting</div>
                      <div class="step-meta">Jan 2024 • 60 kg bags</div>
                    </div>
                  </div>
                  
                  <div class="journey-step active">
                    <div class="step-icon">
                      <i class="fas fa-ship"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Export & Shipping</div>
                      <div class="step-description">FOB Mombasa, container shipment to Dubai</div>
                      <div class="step-meta">Feb 2024 • 42 bags shipped</div>
                    </div>
                  </div>
                  
                  <div class="journey-step active">
                    <div class="step-icon">
                      <i class="fas fa-warehouse"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Warehouse Storage</div>
                      <div class="step-description">Temperature-controlled storage in Dubai</div>
                      <div class="step-meta">Mar 2024 • Warehouse A, Bin 12</div>
                    </div>
                  </div>
                  
                  <div class="journey-step">
                    <div class="step-icon">
                      <i class="fas fa-fire"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Roasting</div>
                      <div class="step-description">Light roast profile, filter preparation</div>
                      <div class="step-meta">Scheduled: Apr 2024</div>
                    </div>
                  </div>
                  
                  <div class="journey-step">
                    <div class="step-icon">
                      <i class="fas fa-mug-hot"></i>
                    </div>
                    <div class="step-content">
                      <div class="step-title">Consumer Enjoyment</div>
                      <div class="step-description">Retail distribution & home brewing</div>
                      <div class="step-meta">Future consumption</div>
                    </div>
                  </div>
                </div>
                
                <div class="journey-actions">
                  <button class="btn btn-outline">
                    <i class="fas fa-expand"></i>
                    View Full Journey
                  </button>
                  <button class="btn btn-primary">
                    <i class="fas fa-share-alt"></i>
                    Share This Story
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Shareable Links & QR Codes -->
            <div class="panel">
              <div class="panel-header">
                <h2><i class="fas fa-link"></i> Shareable Trace Links</h2>
                <div class="panel-actions">
                  <button class="btn btn-ghost" id="generate-qr-btn">
                    <i class="fas fa-qrcode"></i>
                    Generate QR
                  </button>
                </div>
              </div>
              <div class="panel-body">
                <p class="panel-meta">
                  Use these links on your webshop or QR codes so consumers can explore farm‑level details.
                </p>
                
                <div class="trace-links">
                  <div class="trace-link-item">
                    <div class="link-info">
                      <div class="link-title">Kenya Kirinyaga Bright</div>
                      <div class="link-url">https://equitycoffee.com/trace/EC-84KIR-2024</div>
                    </div>
                    <div class="link-actions">
                      <button class="btn-icon-small" title="Copy Link">
                        <i class="fas fa-copy"></i>
                      </button>
                      <button class="btn-icon-small" title="Preview">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="trace-link-item">
                    <div class="link-info">
                      <div class="link-title">Gedeo Natural Filter</div>
                      <div class="link-url">https://equitycoffee.com/trace/EC-ET-GD-24</div>
                    </div>
                    <div class="link-actions">
                      <button class="btn-icon-small" title="Copy Link">
                        <i class="fas fa-copy"></i>
                      </button>
                      <button class="btn-icon-small" title="Preview">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div class="trace-link-item">
                    <div class="link-info">
                      <div class="link-title">House Espresso Blend</div>
                      <div class="link-url">https://equitycoffee.com/trace/EC-BL-HSE-01</div>
                    </div>
                    <div class="link-actions">
                      <button class="btn-icon-small" title="Copy Link">
                        <i class="fas fa-copy"></i>
                      </button>
                      <button class="btn-icon-small" title="Preview">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="qr-preview">
                  <div class="qr-code">
                    <div class="qr-placeholder">
                      <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="qr-info">
                      <div class="qr-title">EC-84KIR-2024</div>
                      <div class="qr-desc">Scan to trace this coffee</div>
                    </div>
                  </div>
                  <div class="qr-actions">
                    <button class="btn btn-outline">
                      <i class="fas fa-download"></i>
                      Download PNG
                    </button>
                    <button class="btn btn-primary">
                      <i class="fas fa-print"></i>
                      Print Label
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
      
      <footer class="dashboard-footer">
        <div class="footer-content">
          <span class="copyright">© 2024 Equity Coffee. All rights reserved.</span>
          <div class="footer-links">
            <a href="#">Traceability Standards</a>
            <a href="#">QR Guidelines</a>
            <a href="#">Consumer Privacy</a>
          </div>
        </div>
      </footer>
    </div>
  </div>

  <!-- Trace Details Modal -->
  <div id="trace-modal" class="modal-overlay" style="display: none;">
    <div class="modal modal-xl">
      <div class="modal-header">
        <h3><i class="fas fa-map-marked-alt"></i> Complete Trace Journey</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="trace-detail">
          <div class="trace-header">
            <div class="trace-title">
              <h4>Kenya Kirinyaga Bright</h4>
              <span class="trace-code">EC-84KIR-2024</span>
            </div>
            <div class="trace-meta">
              <span class="meta-item">
                <i class="fas fa-map-marker-alt"></i>
                Kirinyaga, Kenya
              </span>
              <span class="meta-item">
                <i class="fas fa-star"></i>
                87.5 cupping score
              </span>
              <span class="meta-item">
                <i class="fas fa-weight-hanging"></i>
                42 bags (840 kg)
              </span>
            </div>
          </div>
          
          <div class="trace-content">
            <div class="trace-section">
              <h5>Farm Information</h5>
              <div class="farm-details">
                <div class="farm-info">
                  <div class="farm-name">Kirinyaga Cooperative Society</div>
                  <div class="farm-location">Central Province, Kenya</div>
                  <div class="farm-stats">
                    <span class="stat">Altitude: 1,600-1,800m</span>
                    <span class="stat">Variety: SL-28, SL-34</span>
                    <span class="stat">Process: Fully Washed</span>
                  </div>
                </div>
                <div class="farm-image">
                  <div class="image-placeholder">
                    <i class="fas fa-image"></i>
                    <span>Farm Photo</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="trace-section">
              <h5>Processing Details</h5>
              <div class="processing-timeline">
                <div class="process-step">
                  <div class="step-title">Harvest</div>
                  <div class="step-date">December 2023</div>
                  <div class="step-desc">Hand-picked ripe cherries by local farmers</div>
                </div>
                <div class="process-step">
                  <div class="step-title">Pulping & Fermentation</div>
                  <div class="step-date">December 2023</div>
                  <div class="step-desc">24-hour fermentation, washed channels</div>
                </div>
                <div class="process-step">
                  <div class="step-title">Drying</div>
                  <div class="step-date">January 2024</div>
                  <div class="step-desc">Raised beds, 15-20 days drying period</div>
                </div>
                <div class="process-step">
                  <div class="step-title">Milling & Grading</div>
                  <div class="step-date">January 2024</div>
                  <div class="step-desc">Dry milling, AB grade sorting, color sorting</div>
                </div>
              </div>
            </div>
            
            <div class="trace-section">
              <h5>Quality & Certifications</h5>
              <div class="quality-info">
                <div class="quality-cupping">
                  <div class="cupping-score">
                    <span class="score-value">87.5</span>
                    <span class="score-label">Cupping Score</span>
                  </div>
                  <div class="cupping-notes">
                    <div class="note-title">Flavor Profile</div>
                    <div class="note-content">Blackcurrant, red grape, brown sugar, tea-like finish</div>
                  </div>
                </div>
                <div class="certifications">
                  <span class="cert-badge">
                    <i class="fas fa-leaf"></i>
                    Organic
                  </span>
                  <span class="cert-badge">
                    <i class="fas fa-handshake"></i>
                    Fair Trade
                  </span>
                  <span class="cert-badge">
                    <i class="fas fa-female"></i>
                    Women-Owned
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost modal-close-btn">Close</button>
        <button class="btn btn-primary">
          <i class="fas fa-share-alt"></i>
          Share This Journey
        </button>
      </div>
    </div>
  </div>

  <script src="../js/dashboard.js"></script>
  <script>
    // Traceability Page JavaScript
    class TraceabilityManager {
      constructor() {
        this.init();
      }
      
      init() {
        this.setupEventListeners();
        this.setupDemoData();
      }
      
      setupSearch() {
        // Search is now handled in setupEventListeners
      }
      
      setupEventListeners() {
        // Search tabs
        document.querySelectorAll('.search-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            this.switchSearchTab(tab);
          });
        });
        
        // Search button
        document.getElementById('trace-search-btn').addEventListener('click', () => {
          this.performSearch();
        });
        
        // Enter key in search
        document.getElementById('trace-code').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.performSearch();
          }
        });
        
        // Hint tags
        document.querySelectorAll('.hint-tag').forEach(tag => {
          tag.addEventListener('click', () => {
            const code = tag.dataset.code;
            this.searchByCode(code);
          });
        });
        
        // Trace card actions
        document.querySelectorAll('.trace-actions .btn-icon-small').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.getAttribute('title');
            const card = btn.closest('.trace-card');
            this.handleTraceAction(action, card);
          });
        });
        
        // Trace card click
        document.querySelectorAll('.trace-card').forEach(card => {
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.trace-actions')) {
              this.showTraceDetails(card);
            }
          });
        });
        
        // Journey actions
        document.querySelector('.journey-actions .btn-outline').addEventListener('click', () => {
          this.showTraceModal();
        });
        
        document.querySelector('.journey-actions .btn-primary').addEventListener('click', () => {
          this.shareJourney();
        });
        
        // Link actions
        document.querySelectorAll('.link-actions .btn-icon-small').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.getAttribute('title');
            const linkItem = btn.closest('.trace-link-item');
            this.handleLinkAction(action, linkItem);
          });
        });
        
        // QR generation
        document.getElementById('generate-qr-btn').addEventListener('click', () => {
          this.generateQRCode();
        });
        
        // QR actions
        document.querySelectorAll('.qr-actions .btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const action = btn.querySelector('i').className.includes('download') ? 'download' : 'print';
            this.handleQRAction(action);
          });
        });
        
        // Modal handling
        document.querySelectorAll('.modal-close, .modal-close-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.getElementById('trace-modal').style.display = 'none';
          });
        });
      }
      
      switchSearchTab(tab) {
        document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabType = tab.dataset.tab;
        const input = document.getElementById('trace-code');
        
        const placeholders = {
          lot: 'Enter lot code (e.g., EC-84KIR-2024)',
          qr: 'Enter QR code or scan',
          farm: 'Enter farm name or cooperative'
        };
        
        input.placeholder = placeholders[tabType] || 'Enter search term...';
      }
      
      performSearch() {
        const query = document.getElementById('trace-code').value.trim();
        const activeTab = document.querySelector('.search-tab.active').dataset.tab;
        
        if (!query) {
          this.showNotification('Please enter a search term', 'warning');
          return;
        }
        
        // Show loading state
        const searchBtn = document.getElementById('trace-search-btn');
        const originalHtml = searchBtn.innerHTML;
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        searchBtn.disabled = true;
        
        // Simulate search
        setTimeout(() => {
          searchBtn.innerHTML = originalHtml;
          searchBtn.disabled = false;
          
          if (this.isValidCode(query)) {
            this.showTraceResult(query);
          } else {
            this.showNotification(`No trace found for "${query}"`, 'error');
          }
        }, 1000);
      }
      
      searchByCode(code) {
        document.getElementById('trace-code').value = code;
        this.performSearch();
      }
      
      isValidCode(code) {
        // Simple validation - in real app, this would check against database
        const validCodes = ['EC-84KIR-2024', 'EC-ET-GD-24', 'LOT-2024-BR-001', 'KIR-AB-12', 'GED-NAT-24', 'CER-EST-21'];
        return validCodes.includes(code) || code.length > 5;
      }
      
      showTraceResult(code) {
        // In a real app, this would show the actual trace result
        this.showTraceModal();
        this.showNotification(`Trace found for ${code}. Loading details...`, 'success');
      }
      
      handleTraceAction(action, card) {
        const traceCode = card.querySelector('.trace-code').textContent;
        
        const actions = {
          'View Full Trace': () => {
            this.showTraceModal();
          },
          'Share Link': () => {
            this.shareTraceLink(traceCode);
          },
          'Download Report': () => {
            this.downloadTraceReport(traceCode);
          }
        };
        
        if (actions[action]) {
          actions[action]();
        }
      }
      
      showTraceDetails(card) {
        const traceName = card.querySelector('.trace-name').textContent;
        const traceCode = card.querySelector('.trace-code').textContent;
        
        this.showModal('Trace Details', `Showing detailed information for:\n\n${traceName}\n(${traceCode})\n\nThis would include:\n• Complete journey timeline\n• Farm information\n• Processing details\n• Quality reports\n• Certifications\n• Transportation logs`);
      }
      
      showTraceModal() {
        document.getElementById('trace-modal').style.display = 'flex';
      }
      
      shareJourney() {
        const journeyTitle = 'Kenya Kirinyaga Bright Journey';
        const journeyUrl = 'https://equitycoffee.com/trace/EC-84KIR-2024';
        
        if (navigator.share) {
          navigator.share({
            title: journeyTitle,
            text: 'Explore the journey of this coffee from farm to cup',
            url: journeyUrl
          });
        } else {
          this.copyToClipboard(journeyUrl);
          this.showNotification('Journey link copied to clipboard!', 'success');
        }
      }
      
      handleLinkAction(action, linkItem) {
        const linkUrl = linkItem.querySelector('.link-url').textContent;
        const linkTitle = linkItem.querySelector('.link-title').textContent;
        
        if (action === 'Copy Link') {
          this.copyToClipboard(linkUrl);
          this.showNotification(`Link for ${linkTitle} copied to clipboard!`, 'success');
        } else if (action === 'Preview') {
          window.open(linkUrl, '_blank');
        }
      }
      
      copyToClipboard(text) {
        navigator.clipboard.writeText(text).catch(err => {
          console.error('Failed to copy: ', err);
        });
      }
      
      generateQRCode() {
        this.showModal('Generate QR Code', 'Select a lot to generate QR code:\n\n1. Choose from existing lots\n2. Customize QR design\n3. Set destination URL\n4. Generate and download\n\nQR codes can be printed on bags, displays, or marketing materials.');
      }
      
      handleQRAction(action) {
        if (action === 'download') {
          this.showNotification('QR code downloaded as PNG', 'success');
        } else if (action === 'print') {
          this.showNotification('Opening print dialog for QR label', 'info');
        }
      }
      
      setupDemoData() {
        // This would load real data from API
        console.log('Loading traceability data...');
      }
      
      showModal(title, message) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal">
            <div class="modal-header">
              <h3>${title}</h3>
              <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
              <p style="white-space: pre-line;">${message}</p>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary modal-close-btn">OK</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        modal.querySelectorAll('.modal-close, .modal-close-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.body.removeChild(modal);
          });
        });
      }
      
      showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
          <span>${message}</span>
          <button class="notification-close">&times;</button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.opacity = '0';
            setTimeout(() => {
              if (notification.parentNode) {
                document.body.removeChild(notification);
              }
            }, 300);
          }
        }, 5000);
        
        notification.querySelector('.notification-close').addEventListener('click', () => {
          notification.style.opacity = '0';
          setTimeout(() => {
            if (notification.parentNode) {
              document.body.removeChild(notification);
            }
          }, 300);
        });
      }
    }
    
    // Initialize traceability manager
    document.addEventListener('DOMContentLoaded', () => {
      new TraceabilityManager();
    });
  </script>
  
  <style>
    /* Traceability Page Specific Styles */
    
    /* Search Tabs */
    .search-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .search-tab {
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .search-tab:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }
    
    .search-tab.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    /* Search Hints */
    .search-hints {
      margin-top: 1.5rem;
    }
    
    .hint-section {
      margin-bottom: 1rem;
    }
    
    .hint-title {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .hint-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .hint-tag {
      padding: 0.375rem 0.75rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .hint-tag:hover {
      background: var(--border-color);
      transform: translateY(-1px);
    }
    
    /* Trace Cards */
    .traces-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .trace-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .trace-card:hover {
      background: var(--border-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .trace-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .trace-code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .trace-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .trace-content {
      margin-bottom: 1rem;
    }
    
    .trace-origin {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    
    .trace-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .trace-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .trace-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }
    
    .stat-item {
      text-align: center;
      padding: 0.5rem;
      background: var(--bg-card);
      border-radius: 6px;
    }
    
    .stat-value {
      font-weight: 700;
      font-size: 1.125rem;
      margin-bottom: 0.125rem;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .trace-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }
    
    /* Journey Timeline */
    .journey-timeline {
      margin-bottom: 1.5rem;
    }
    
    .journey-step {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      border-left: 3px solid var(--border-color);
      margin-left: 0.75rem;
      position: relative;
    }
    
    .journey-step.active {
      border-left-color: var(--primary-color);
    }
    
    .journey-step:last-child {
      border-left-color: transparent;
    }
    
    .journey-step::before {
      content: '';
      position: absolute;
      left: -0.5rem;
      top: 1.5rem;
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
      background: var(--border-color);
      border: 2px solid var(--bg-card);
    }
    
    .journey-step.active::before {
      background: var(--primary-color);
    }
    
    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      flex-shrink: 0;
    }
    
    .journey-step.active .step-icon {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
      color: white;
    }
    
    .step-content {
      flex: 1;
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .step-description {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }
    
    .step-meta {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .journey-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }
    
    /* Trace Links */
    .trace-links {
      margin: 1rem 0;
    }
    
    .trace-link-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--bg-secondary);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }
    
    .link-info {
      flex: 1;
      overflow: hidden;
    }
    
    .link-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .link-url {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .link-actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
    }
    
    /* QR Preview */
    .qr-preview {
      text-align: center;
      padding: 1.5rem;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-top: 1.5rem;
    }
    
    .qr-code {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .qr-placeholder {
      width: 120px;
      height: 120px;
      background: var(--bg-card);
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
    }
    
    .qr-placeholder i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .qr-info {
      text-align: left;
    }
    
    .qr-title {
      font-weight: 600;
      font-size: 1.125rem;
      margin-bottom: 0.25rem;
    }
    
    .qr-desc {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .qr-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
    }
    
    /* Modal XL */
    .modal-xl {
      max-width: 800px;
    }
    
    /* Trace Detail */
    .trace-detail {
      max-height: 60vh;
      overflow-y: auto;
    }
    
    .trace-header {
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }
    
    .trace-title {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .trace-title h4 {
      margin: 0;
      font-size: 1.25rem;
    }
    
    .trace-code {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      background: var(--bg-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    
    .trace-meta {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .meta-item i {
      margin-right: 0.5rem;
    }
    
    .trace-section {
      margin-bottom: 2rem;
    }
    
    .trace-section h5 {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }
    
    .farm-details {
      display: flex;
      gap: 1.5rem;
    }
    
    .farm-info {
      flex: 1;
    }
    
    .farm-name {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    
    .farm-location {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }
    
    .farm-stats {
      display: flex;
      gap: 1.5rem;
      font-size: 0.875rem;
    }
    
    .farm-stats .stat {
      padding: 0.5rem;
      background: var(--bg-secondary);
      border-radius: 4px;
    }
    
    .farm-image {
      width: 150px;
      height: 100px;
      background: var(--bg-secondary);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-light);
      flex-shrink: 0;
    }
    
    .processing-timeline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .process-step {
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 6px;
    }
    
    .step-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .step-date {
      font-size: 0.75rem;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .step-desc {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .quality-info {
      display: flex;
      gap: 2rem;
      align-items: center;
    }
    
    .quality-cupping {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }
    
    .cupping-score {
      text-align: center;
    }
    
    .score-value {
      display: block;
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .score-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .cupping-notes {
      flex: 1;
    }
    
    .note-title {
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .certifications {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .cert-badge {
      padding: 0.5rem 0.75rem;
      background: var(--bg-secondary);
      border-radius: 999px;
      font-size: 0.75rem;
      color: var(--text-primary);
    }
    
    .cert-badge i {
      margin-right: 0.5rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .search-tabs {
        flex-direction: column;
      }
      
      .search-tab {
        width: 100%;
        text-align: center;
      }
      
      .search-input-group {
        flex-direction: column;
      }
      
      .search-input-group .btn {
        width: 100%;
        margin-top: 0.5rem;
      }
      
      .trace-stats {
        grid-template-columns: 1fr;
      }
      
      .journey-actions,
      .qr-actions {
        flex-direction: column;
      }
      
      .qr-code {
        flex-direction: column;
        text-align: center;
      }
      
      .qr-info {
        text-align: center;
      }
      
      .modal-xl {
        width: 95%;
        max-width: 95%;
      }
      
      .farm-details {
        flex-direction: column;
      }
      
      .farm-image {
        width: 100%;
        height: 150px;
      }
      
      .quality-info {
        flex-direction: column;
        align-items: stretch;
      }
      
      .trace-meta {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
  <script src="../js/common-auth.js"></script>
</body>
</html>